<!DOCTYPE html>
<html>
<head>
    <title>TagAssist â€“ Tag Change Validation</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

<div class="container mt-5" style="max-width: 900px;">

    <h3 class="mb-4 text-center">Tag Change Validation System</h3>

    <!-- ================= INPUT CARD ================= -->
    <div class="card p-4 shadow-sm mb-4">

        <form method="POST">

            <div class="row mb-3">
                <div class="col">
                    <label class="form-label">Order Velocity</label>
                    <input type="number" step="0.1" name="order_velocity"
                           class="form-control"
                           value="{{ case_data.order_velocity }}">
                </div>

                <div class="col">
                    <label class="form-label">Device Changes (7d)</label>
                    <input type="number" name="device_changes"
                           class="form-control"
                           value="{{ case_data.device_changes }}">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col">
                    <label class="form-label">IP Changes (7d)</label>
                    <input type="number" name="ip_changes"
                           class="form-control"
                           value="{{ case_data.ip_changes }}">
                </div>

                <div class="col">
                    <label class="form-label">Unpaid Ratio</label>
                    <input type="number" step="0.01" name="unpaid_ratio"
                           class="form-control"
                           value="{{ case_data.unpaid_ratio }}">
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">High Risk Category (0 / 1)</label>
                <input type="number" name="risky_flag"
                       class="form-control"
                       value="{{ case_data.risky_flag }}">
            </div>

            <div class="mb-4">
                <label class="form-label">Approval Threshold</label>
                <input type="range"
                       min="0.3" max="0.9" step="0.05"
                       name="threshold"
                       value="{{ threshold }}"
                       class="form-range"
                       oninput="document.getElementById('tval').innerText=this.value">
                <small>Threshold: <span id="tval">{{ threshold }}</span></small>
            </div>

            <div class="mb-4">
                <label class="form-label">Annotation</label>
                <textarea name="annotation" rows="4"
                          class="form-control">{{ case_data.annotation }}</textarea>
            </div>

            <!-- BUTTONS (CLEAN BOOTSTRAP) -->
            <div class="d-flex gap-3 mt-3">
                <button type="submit" class="btn btn-primary px-4">
                    Evaluate
                </button>

                <a href="/" class="btn btn-outline-secondary px-4">
                    Load Next Case
                </a>
            </div>

        </form>
    </div>

    {% if final_score %}

    <!-- ================= VALIDATION SUMMARY ================= -->
    <div class="card p-4 shadow-sm mb-4">

        <h4 class="mb-4">Validation Summary</h4>

        <h2 class="fw-bold">
            {{ (final_score * 100)|round(1) }}%
        </h2>
        <p>Final Validation Confidence</p>

        <h5 class="mt-3">
            Recommendation:
            <span class="{% if decision == 'APPROVE' %}text-success{% else %}text-danger{% endif %}">
                {{ decision }}
            </span>
        </h5>

        {% if decision == "APPROVE" %}
            <p>Eligible for auto-approval under current threshold ({{ threshold }}).</p>
        {% else %}
            <p>Requires manual review under current threshold ({{ threshold }}).</p>
        {% endif %}

        <hr>

        <h5>Operational Impact</h5>
        <p>Estimated Auto-Approval Rate (Session): {{ approval_rate }}%</p>
        <p>Estimated Manual Review Reduction: {{ approval_rate }}%</p>

    </div>

    <!-- ================= SIGNAL BREAKDOWN ================= -->
    <div class="card p-4 shadow-sm mb-4">

        <h5 class="mb-3">Signal Breakdown</h5>

        <p><strong>Behavioral Risk Signal:</strong> {{ (behavior_score * 100)|round(1) }}%</p>
        <p><strong>Investigator Reasoning Alignment:</strong> {{ (text_score * 100)|round(1) }}%</p>

        <div class="progress mt-3">
            <div class="progress-bar bg-primary"
                 style="width: {{ final_score * 100 }}%">
            </div>
        </div>

    </div>

    <!-- ================= CASE HISTORY ================= -->
    <div class="card p-4 shadow-sm mb-5">

        <h5>Case History</h5>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Request ID</th>
                    <th>Score</th>
                    <th>Decision</th>
                </tr>
            </thead>
            <tbody>
                {% for case in case_history %}
                <tr>
                    <td>{{ case.id }}</td>
                    <td>{{ case.score }}</td>
                    <td>
                        <span class="{% if case.decision == 'APPROVE' %}text-success{% else %}text-danger{% endif %}">
                            {{ case.decision }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% endif %}

</div>

</body>
</html>
